{% extends "layout.html" %}
{% block body %}
<script>
    var app = angular.module('myApp',['timer','ngAudio']);
    app.controller('eventsCtrl', function($rootScope, $scope, $http, $timeout){
        $scope.events = null;
        (function update(){
            $http.get('http://localhost:5000/get_events')
                    .success(function(response) {
                        $scope.events = response.result.events;
//                        console.log($scope.events);
                    });
            $timeout(update,1000000);
        })();

        $scope.formatDate = function(date)
        {
            var thisDate = new Date();
            thisDate.setTime(Date.parse(date));
//            console.log("event time:" + thisDate.getHours() + ":" + thisDate.getMinutes());
            return thisDate.getHours() + ":" + thisDate.getMinutes();
        };
        $scope.getMachineTime = function(date){
            return Date.parse(date);
        };
        $scope.getTimeNow = function(){
            //console.log(new Date().getTime());
            return new Date().getTime();
        };

        $scope.countTime = function(date) {
            var interval = Date.parse(date) - new Date().getTime();
//            console.log(interval);
            return interval;
        };
        $scope.stopTimer = function() {
          $scope.$broadcast('timer-stop');
        };
        $scope.$on('timer-stopped', function (event, data){
                console.log('Timer Stopped - data = ', data);
                $rootScope.$broadcast('playNotificationEvent');
            });
    });

    app.controller('playSound', function($scope, ngAudio){
        $scope.$on('playNotificationEvent',function(){$scope.playMusic()})
        var sound = ngAudio.load("sounds/notification.mp3");
            $scope.playMusic = function(){
              sound.play();
            };
            $scope.stopMusic = function(){
                sound.stop();
            };
            $scope.pauseMusic = function(){
              sound.pause();
            };

    });
</script>

<h1>Events:</h1>


<div ng-app="myApp">
    <div ng-controller="eventsCtrl">
        <table>
            <tbody>
            <tr ng-repeat="e in events">
                <td ng-bind="formatDate(e.start)"></td>
                <th ng-bind="e.summary"></th>
                <td ng-bind="formatDate(e.end)"></td>
                <td ng-if="countTime(e.start)>0">
                <timer interval="1000" countdown="countTime(e.start)/1000">{{minutes|angular}}:{{seconds|angular}}</timer>
                </td>
            </tr>
            </tbody>
        </table>
        <button ng-click="stopTimer()">Stop Timer</button>
    </div>
    <div ng-controller="playSound">
        <button ng-click="playMusic()">Play</button>
        <button ng-click="stopMusic()">Stop</button>
        <button ng-click="pauseMusic()">Pause</button>
    </div>
</div>


{% endblock %}